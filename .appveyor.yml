version: 1.0.{build}


image: Visual Studio 2019


branches:
  only:
  - master



before_install:
  - cmd: set build=2020.01
  
install:
  - '"C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"'
#  - '"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /x64'
  - appveyor-retry choco install strawberryperl --allow-empty-checksums
  - appveyor-retry choco install innosetup wget
  - SET PATH=C:\strawberry\c\bin;C:\strawberry\perl\site\bin;C:\strawberry\perl\bin;C:\Program Files (x86)\Inno Setup 6\;%PATH%

build_script:
  - wget https://github.com/rakudo/rakudo/releases/download/%build%/rakudo-%build%.tar.gz && tar -xzf rakudo-%build%.tar.gz
  - mkdir rakudo-old
  - cd rakudo-%build%/
  - perl Configure.pl --gen-moar --gen-nqp --backends=moar --relocatable --prefix=%APPVEYOR_BUILD_FOLDER%/rakudo-old
  - nmake install
  - cd %APPVEYOR_BUILD_FOLDER%
  - rm -rf rakudo-%build% rakudo-%build%.tar.gz
  - SET PATH=%APPVEYOR_BUILD_FOLDER%\rakudo-old\bin;%APPVEYOR_BUILD_FOLDER%\rakudo-old\share\perl6\site\bin;%PATH%
  - git clone -b master --single-branch https://github.com/ugexe/zef.git
  - cd zef
  - raku -I. bin/zef install .
  - zef install App::Mi6 App::Prove6
  #zef stuff here
  - cd ..
  - 7z a rakudo-%build%-x86_64(JIT).zip ./rakudo-old/*
  - iscc %APPVEYOR_BUILD_FOLDER%/rakudo-${build}.iss
    
test_script:
  - git clone -b master --single-branch https://github.com/rakudo/rakudo.git
  - mkdir rakudo-new
  - cd rakudo
  - perl Configure.pl --gen-moar --gen-nqp --backends=moar --relocatable --prefix=%APPVEYOR_BUILD_FOLDER%/rakudo-new
  - nmake install
  - cd %APPVEYOR_BUILD_FOLDER%
  - rm -rf rakudo
  - SET PATH=%APPVEYOR_BUILD_FOLDER%\rakudo-new\bin;%APPVEYOR_BUILD_FOLDER%\rakudo-new\share\perl6\site\bin;%PATH%
  - cd zef
  - raku -I. bin/zef install .
  - zef install App::Mi6 App::Prove6
  #zef stuff here
  - cd ..
  - 7z a rakudo-daily-x86_64(JIT).zip ./rakudo-new/*
  - iscc %APPVEYOR_BUILD_FOLDER%/rakudo-daily.iss

artifacts:
  - path: 'rakudo-%build%-x86_64(JIT).zip'
    name: rakudo-%build%
  - path: 'rakudo-%build%-x86_64(JIT).exe'
    name: rakudo-%build%-installer
  - path: 'rakudo-daily-x86_64(JIT).zip'
    name: rakudo-daily
  - path: 'rakudo-daily-x86_64(JIT).exe'
    name: rakudo-daily-installer

deploy:
  tag: 2020.01
  release: Rakudo latest and daily
  description: 'zip and executable build of rakudo 2020.01 and daily'
  provider: GitHub
  auth_token:
    secure: hy0QQSh7MfmaPRkoz382B7rQ4gkgfWlh0n2vfM9Lh0DU7ZidW/RQwo3MZSZJlpCh
  artifact: rakudo-%build%, rakudo-%build%-installer, rakudo-daily, rakudo-daily-installer 
  draft: false
  prerelease: false
  force_update: true
  on:
    branch: master    
