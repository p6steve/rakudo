version: 1.0.{build}
image: Visual Studio 2019

branches:
  only:
  - master


install:
  - '"C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"'
#  - '"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /x64'
  - appveyor-retry choco install strawberryperl --allow-empty-checksums
  - appveyor-retry choco install innosetup wget
 
before_build:
  - SET PATH=C:\msys64\usr\bin;C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\bin;C:\strawberry\c\bin;C:\strawberry\perl\site\bin;C:\strawberry\perl\bin;C:\Program Files (x86)\Inno Setup 6\;%PATH%
 
build_script:
  - wget https://github.com/rakudo/rakudo/releases/download/2019.11/rakudo-2019.11.tar.gz && tar -xzf rakudo-2019.11.tar.gz
  - ren rakudo-2019.11 rakudo-source
  - mkdir rakudo-old
  - cd rakudo-source/
  - perl Configure.pl --gen-moar --gen-nqp --backends=moar --prefix=%APPVEYOR_BUILD_FOLDER%/rakudo-old
  - gmake install
  - cd %APPVEYOR_BUILD_FOLDER%
  - rm -rf rakudo-source rakudo-2019.11.tar.gz
  - cp C:\strawberry\perl\bin\libwinpthread-1.dll C:\projects\rakudo\rakudo-old\bin
  - cp C:\strawberry\perl\bin\libgcc_s_seh-1.dll C:\projects\rakudo\rakudo-old\bin
  - SET PATH=C:\projects\rakudo\rakudo-old\bin;C:\projects\rakudo\rakudo-old\share\perl6\site\bin;%PATH%
  - git clone https://github.com/ugexe/zef.git
  - cd zef
  - perl6 -I. bin/zef install .
  - zef install App::Mi6 App::Prove6
  #zef stuff here
  - cd ..
  - 7z a rakudo-latest-x86_64(JIT).zip ./rakudo-old/*
  - iscc %APPVEYOR_BUILD_FOLDER%/rakudo-latest.iss
    
